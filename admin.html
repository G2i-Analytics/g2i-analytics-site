<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G2i Analytics • Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Montserrat', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { DEFAULT: '#ff5a1f', 600: '#e5521c', 700: '#c64616' } },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    }
  </script>
  <!-- CORREÇÃO: usar o mesmo nome do arquivo no repo (Logo.png com L maiúsculo) -->
  <link rel="icon" href="./Logo.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="./app-config.js"></script>
  <style> body{font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial} </style>
</head>
<body class="bg-gray-50 text-slate-900">
  <header class="bg-white shadow-soft border-b border-slate-100">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- CORREÇÃO AQUI TAMBÉM -->
        <img src="./Logo.png" alt="G2i" class="w-10 h-10 rounded-lg object-contain"/>
        <div>
          <div class="text-xl font-extrabold tracking-tight">G2i Analytics</div>
          <div class="text-xs text-slate-500 -mt-0.5">Painel Administrativo</div>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <a href="./app.html" class="px-3 py-1.5 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 text-sm font-semibold">Hub</a>
        <button id="logout" class="px-3 py-1.5 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 text-sm font-semibold">Sair</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-6">
      <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-brand/10 text-brand-700 border border-brand/30">Acessos</span>
      <h1 class="text-2xl md:text-3xl font-extrabold mt-3">Gerenciar permissões de páginas</h1>
      <p class="text-slate-600 mt-1">Conceda ou revogue acesso por e-mail. As alterações são aplicadas imediatamente.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section class="bg-white border border-slate-100 rounded-2xl p-6 shadow-soft">
        <h2 class="text-lg font-bold mb-4">Conceder / Revogar</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1" for="email">E-mail do usuário</label>
            <input id="email" type="email" placeholder="usuario@empresa.com.br"
                   class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand/20">
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1" for="page">Página</label>
            <select id="page"
                    class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand/20">
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1" for="perm">Permissão</label>
            <select id="perm"
                    class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand/20">
              <option value="true">Liberar</option>
              <option value="false">Revogar</option>
            </select>
          </div>
          <div class="flex items-center gap-3">
            <button id="apply" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-brand text-white font-bold hover:bg-brand-600 active:bg-brand-700">
              Aplicar
            </button>
            <div id="status" class="hidden px-3 py-2 rounded-xl text-sm border"></div>
          </div>
        </div>
      </section>

      <section class="bg-white border border-slate-100 rounded-2xl p-6 shadow-soft">
        <h2 class="text-lg font-bold mb-4">Acessos do usuário</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1" for="emailList">E-mail</label>
            <input id="emailList" type="email" placeholder="usuario@empresa.com.br"
                   class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand/20">
          </div>
          <button id="list" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-800 font-bold hover:bg-slate-50">
            Listar acessos
          </button>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-500 border-b border-slate-200">
                  <th class="py-2 pr-4">Página</th>
                  <th class="py-2">Status</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-xs text-slate-500">© G2i — Todos os direitos reservados.</footer>

  <script>
    function showStatus(ok, msg){
      const el = document.getElementById('status');
      el.classList.remove('hidden');
      el.textContent = msg;
      el.className = 'px-3 py-2 rounded-xl text-sm border ' + (ok
        ? 'bg-green-50 text-green-700 border-green-200'
        : 'bg-red-50 text-red-700 border-red-200');
    }

    (async () => {
      const cfg = window.APP_CONFIG || {};
      const { createClient } = window.supabase;
      const supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) { location.replace('/login.html?next=' + encodeURIComponent(location.pathname)); return; }

      const { data: allowed } = await supabase
        .from('user_pages').select('page_id, can_view')
        .eq('user_id', session.user.id).eq('page_id', 'admin').eq('can_view', true).limit(1);
      if (!allowed || !allowed.length){ location.replace('/no-access.html'); return; }

      const sel = document.getElementById('page');
      const { data: pages, error: pagesErr } = await supabase.from('pages').select('page_id,title').order('title');
      if (pagesErr) { showStatus(false, 'Erro carregando páginas: ' + pagesErr.message); }
      (pages||[]).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.page_id;
        opt.textContent = `${p.title} (${p.page_id})`;
        sel.appendChild(opt);
      });

      document.getElementById('apply').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const pageId = document.getElementById('page').value;
        const canView = document.getElementById('perm').value === 'true';
        showStatus(true, 'Aplicando...');
        const { error } = await supabase.rpc('admin_set_access', { target_email: email, target_page_id: pageId, target_can_view: canView });
        if (error) showStatus(false, 'Erro: ' + error.message); else showStatus(true, 'OK. Permissão atualizada.');
      });

      document.getElementById('list').addEventListener('click', async () => {
        const email = document.getElementById('emailList').value.trim();
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '<tr><td class="py-3 text-slate-500" colspan="2">Carregando...</td></tr>';
        const { data, error } = await supabase.rpc('admin_list_access', { target_email: email });
        if (error) { tbody.innerHTML = '<tr><td class="py-3 text-red-600" colspan="2">Erro: ' + error.message + '</td></tr>'; return; }
        if (!data || !data.length) { tbody.innerHTML = '<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma permissão para este usuário.</td></tr>'; return; }
        tbody.innerHTML = data.map(r => `<tr class="border-b border-slate-100"><td class="py-2 pr-4">${r.page_id}</td><td class="py-2">${r.can_view ? '✅ Liberado' : '❌ Revogado'}</td></tr>`).join('');
      });

      document.getElementById('logout').addEventListener('click', async () => {
        await supabase.auth.signOut();
        location.replace('/login.html');
      });
    })();
  </script>
</body>
</html>
